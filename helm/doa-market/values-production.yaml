# Production environment overrides

global:
  environment: production
  domain: doa-market.com
  registry: 478266318018.dkr.ecr.ap-northeast-2.amazonaws.com

# Production resource limits (optimized for initial deployment)
defaults:
  replicaCount: 1

  # Ingress configuration for AWS ALB
  ingress:
    enabled: true
    className: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
      alb.ingress.kubernetes.io/ssl-redirect: '443'
      alb.ingress.kubernetes.io/healthcheck-path: /health
      alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
      alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
      alb.ingress.kubernetes.io/healthy-threshold-count: '2'
      alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 50m
      memory: 128Mi

  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  service:
    type: ClusterIP
    port: 80

  # Pod Disruption Budget (고가용성 보장)
  # Replica 1개일 때는 비활성화
  podDisruptionBudget:
    enabled: false
    maxUnavailable: 1  # 동시에 1개 Pod만 중단 가능

  # Spot Instance 설정
  spotEnabled: true
  tolerations:
    - key: spot
      operator: Equal
      value: "true"
      effect: NoSchedule

  # Node Affinity (Spot 선호)
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 80
        preference:
          matchExpressions:
            - key: eks.amazonaws.com/capacityType
              operator: In
              values:
                - SPOT
      - weight: 20
        preference:
          matchExpressions:
            - key: eks.amazonaws.com/capacityType
              operator: In
              values:
                - ON_DEMAND

# Critical services with higher resources
services:
  api-gateway:
    replicaCount: 1
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 50m
        memory: 128Mi
    autoscaling:
      minReplicas: 1
      maxReplicas: 10

  inventory-service:
    env:
      - name: RABBITMQ_ENABLED
        value: "false"

  payment-service:
    env:
      - name: RABBITMQ_ENABLED
        value: "false"

  search-service:
    env:
      - name: RABBITMQ_ENABLED
        value: "false"
      - name: OPENSEARCH_ENABLED
        value: "false"

  product-service:
    replicaCount: 1
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 50m
        memory: 128Mi
    autoscaling:
      minReplicas: 1
      maxReplicas: 10

  order-service:
    replicaCount: 1
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 50m
        memory: 128Mi
    autoscaling:
      minReplicas: 1
      maxReplicas: 10

  payment-service:
    replicaCount: 1
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 50m
        memory: 128Mi
    autoscaling:
      minReplicas: 1
      maxReplicas: 10
    # Critical: On-Demand만 사용 (중단 불가)
    spotEnabled: false
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: eks.amazonaws.com/capacityType
                operator: In
                values:
                  - ON_DEMAND
    tolerations: []  # Spot toleration 제거

  # Auth Service도 On-Demand만 사용
  auth-service:
    spotEnabled: false
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: eks.amazonaws.com/capacityType
                operator: In
                values:
                  - ON_DEMAND
    tolerations: []

# Production database configuration
database:
  host: doa-market-rds.cluster-c3e8ci0mgsqi.ap-northeast-2.rds.amazonaws.com
  port: 5432
  existingSecret: db-credentials-prod

# Production Redis
redis:
  host: master.doa-market-redis.3agi26.apn2.cache.amazonaws.com
  port: 6379
  existingSecret: redis-credentials-prod

# Production RabbitMQ (disabled - using SNS/SQS instead)
rabbitmq:
  enabled: false
  host: ""
  port: 5672
  existingSecret: rabbitmq-credentials-prod

# Node affinity for production
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: workload-type
          operator: In
          values:
          - application
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - doa-market
        topologyKey: kubernetes.io/hostname
